@using Mwh.Sample.Domain.Interfaces
@using Mwh.Sample.Domain.Models
@inject IEmployeeService EmployeeService

<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-0">
                        <i class="bi bi-lightning text-primary me-2"></i>Blazor Employee CRUD
                    </h1>
                    <p class="text-muted">Real-time CRUD with Blazor Server and SignalR — pure C#, no JavaScript</p>
                </div>
                <button type="button" class="btn btn-primary" @onclick="OpenAdd">
                    <i class="bi bi-plus-circle me-2"></i>Add Employee
                </button>
            </div>

            @if (!string.IsNullOrEmpty(toastMessage))
            {
                <div class="alert @(toastType == "success" ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
                    <strong>@(toastType == "success" ? "Success" : "Error"):</strong> @toastMessage
                    <button type="button" class="btn-close" @onclick="DismissToast"></button>
                </div>
            }

            <div class="card shadow-sm rounded-3 border-0">
                <div class="card-body pb-0">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label class="me-2"><i class="bi bi-list-ul"></i></label>
                                <select class="form-select form-select-sm" style="width: auto"
                                        @bind="pageSize">
                                    <option value="10">10 per page</option>
                                    <option value="25">25 per page</option>
                                    <option value="50">50 per page</option>
                                    <option value="100">100 per page</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control"
                                       placeholder="Search employees..."
                                       @bind="searchTerm" @bind:event="oninput" />
                                @if (!string.IsNullOrEmpty(searchTerm))
                                {
                                    <button class="btn btn-outline-secondary" @onclick="() => searchTerm = string.Empty">
                                        <i class="bi bi-x"></i>
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                @if (loading)
                {
                    <div class="card-body">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Loading employees...</p>
                        </div>
                    </div>
                }
                else
                {
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Profile</th>
                                        <th role="button" class="user-select-none" @onclick='() => ToggleSort("name")'>
                                            Name<i class="ms-1 @SortIcon("name")"></i>
                                        </th>
                                        <th role="button" class="user-select-none" @onclick='() => ToggleSort("genderName")'>
                                            Gender<i class="ms-1 @SortIcon("genderName")"></i>
                                        </th>
                                        <th role="button" class="user-select-none" @onclick='() => ToggleSort("age")'>
                                            Age<i class="ms-1 @SortIcon("age")"></i>
                                        </th>
                                        <th role="button" class="user-select-none" @onclick='() => ToggleSort("state")'>
                                            State<i class="ms-1 @SortIcon("state")"></i>
                                        </th>
                                        <th role="button" class="user-select-none" @onclick='() => ToggleSort("country")'>
                                            Country<i class="ms-1 @SortIcon("country")"></i>
                                        </th>
                                        <th role="button" class="user-select-none" @onclick='() => ToggleSort("departmentName")'>
                                            Department<i class="ms-1 @SortIcon("departmentName")"></i>
                                        </th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (!Paginated.Any())
                                    {
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                @if (!string.IsNullOrEmpty(searchTerm))
                                                {
                                                    <i class="bi bi-search me-2"></i>@:No employees match your search.
                                                }
                                                else
                                                {
                                                    <i class="bi bi-inbox me-2"></i>@:No employees found.
                                                }
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (var emp in Paginated)
                                        {
                                            <tr>
                                                <td class="text-center align-middle">
                                                    <img src="/images/@(emp.ProfilePicture ?? "default.jpg")"
                                                         class="rounded-circle" height="40" width="40"
                                                         alt="@emp.Name"
                                                         onerror="this.src='/images/default.jpg'" />
                                                </td>
                                                <td class="align-middle">@emp.Name</td>
                                                <td class="align-middle">@emp.GenderName</td>
                                                <td class="align-middle">@emp.Age</td>
                                                <td class="align-middle">@emp.State</td>
                                                <td class="align-middle">@emp.Country</td>
                                                <td class="align-middle">@emp.DepartmentName</td>
                                                <td class="text-center align-middle">
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-sm btn-outline-primary"
                                                                @onclick="() => OpenEdit(emp.Id)">
                                                            <i class="bi bi-pencil-square"></i> Edit
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger"
                                                                @onclick="() => OpenDelete(emp)">
                                                            <i class="bi bi-trash"></i> Delete
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">
                                Showing @(Sorted.Count == 0 ? 0 : (currentPage - 1) * pageSize + 1)
                                to @Math.Min(currentPage * pageSize, Sorted.Count)
                                of @Sorted.Count employees
                                @if (!string.IsNullOrEmpty(searchTerm))
                                {
                                    @: (filtered from @employees.Count total)
                                }
                            </span>
                            @if (TotalPages > 1)
                            {
                                <nav aria-label="Employee pagination">
                                    <ul class="pagination pagination-sm mb-0 justify-content-end">
                                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => currentPage = 1"><i class="bi bi-chevron-double-left"></i></button>
                                        </li>
                                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => currentPage--"><i class="bi bi-chevron-left"></i></button>
                                        </li>
                                        @foreach (var p in VisiblePages)
                                        {
                                            <li class="page-item @(p == currentPage ? "active" : "")">
                                                <button class="page-link" @onclick="() => currentPage = p">@p</button>
                                            </li>
                                        }
                                        <li class="page-item @(currentPage == TotalPages ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => currentPage++"><i class="bi bi-chevron-right"></i></button>
                                        </li>
                                        <li class="page-item @(currentPage == TotalPages ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => currentPage = TotalPages"><i class="bi bi-chevron-double-right"></i></button>
                                        </li>
                                    </ul>
                                </nav>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    @* Edit/Add Form *@
    @if (showForm)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5)">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-light">
                        <h5 class="modal-title">@(formEmployee.Id > 0 ? "Update Employee" : "Add Employee")</h5>
                        <button type="button" class="btn-close" @onclick="CloseForm"></button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="formEmployee" OnValidSubmit="HandleSave">
                            <DataAnnotationsValidator />
                            <div class="mb-3">
                                <label for="blazorName" class="form-label">Name</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <InputText id="blazorName" class="form-control" @bind-Value="formEmployee.Name" placeholder="Enter employee name" />
                                </div>
                                <ValidationMessage For="() => formEmployee.Name" />
                            </div>
                            <div class="mb-3">
                                <label for="blazorGender" class="form-label">Gender</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-gender-ambiguous"></i></span>
                                    <InputSelect id="blazorGender" class="form-select" @bind-Value="formEmployee.Gender">
                                        <option value="@GenderEnum.Male">Male</option>
                                        <option value="@GenderEnum.Female">Female</option>
                                        <option value="@GenderEnum.Other">Non-Binary</option>
                                    </InputSelect>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="blazorAge" class="form-label">Age</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                                    <InputNumber id="blazorAge" class="form-control" @bind-Value="formEmployee.Age" placeholder="Enter age" min="18" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="blazorState" class="form-label">State</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                        <InputText id="blazorState" class="form-control" @bind-Value="formEmployee.State" placeholder="Enter state" />
                                    </div>
                                    <ValidationMessage For="() => formEmployee.State" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="blazorCountry" class="form-label">Country</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-globe"></i></span>
                                        <InputText id="blazorCountry" class="form-control" @bind-Value="formEmployee.Country" placeholder="Enter country" />
                                    </div>
                                    <ValidationMessage For="() => formEmployee.Country" />
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="blazorDepartment" class="form-label">Department</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-building"></i></span>
                                    <InputSelect id="blazorDepartment" class="form-select" @bind-Value="formEmployee.Department">
                                        <option value="@EmployeeDepartmentEnum.Unknown" disabled>Select department</option>
                                        @foreach (var dept in departments)
                                        {
                                            <option value="@((EmployeeDepartmentEnum)dept.Id)">@dept.Name</option>
                                        }
                                    </InputSelect>
                                </div>
                            </div>
                            <div class="modal-footer bg-light px-0 pb-0">
                                <button type="submit"
                                        class="btn @(formEmployee.Id > 0 ? "btn-success" : "btn-primary")"
                                        disabled="@saving">
                                    @if (saving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span> @:Saving...
                                    }
                                    else if (formEmployee.Id > 0)
                                    {
                                        <i class="bi bi-check-circle me-1"></i> @:Update
                                    }
                                    else
                                    {
                                        <i class="bi bi-plus-circle me-1"></i> @:Add
                                    }
                                </button>
                                <button type="button" class="btn btn-secondary" @onclick="CloseForm">
                                    <i class="bi bi-x-circle me-1"></i> Close
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Delete Confirmation *@
    @if (deleteTarget is not null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5)">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete
                        </h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="() => deleteTarget = null"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete <strong>@deleteTarget.Name</strong>?</p>
                        <p class="text-muted mb-0">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" @onclick="() => deleteTarget = null">
                            <i class="bi bi-x-circle me-1"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="HandleDelete">
                            <i class="bi bi-trash me-1"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Documentation Section -->
    <div class="row mt-5">
        <div class="col-md-12">
            <div class="card shadow-sm rounded-3 border-0 mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="bi bi-info-circle me-2"></i>About Blazor Server Implementation</h3>
                </div>
                <div class="card-body p-4">
                    <p class="lead">
                        This implementation demonstrates Blazor Server, which runs C# components on the server
                        and updates the UI in real-time over a SignalR WebSocket connection. No JavaScript is
                        required for CRUD logic.
                    </p>

                    <div class="row g-4 mt-2">
                        <div class="col-md-6">
                            <div class="card h-100 bg-light border-0">
                                <div class="card-body">
                                    <h4 class="card-title"><i class="bi bi-stars text-warning me-2"></i>Blazor Server Advantages</h4>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item bg-transparent border-0"><i class="bi bi-check-circle-fill text-success me-2"></i>Full C# — no JavaScript needed for UI logic</li>
                                        <li class="list-group-item bg-transparent border-0"><i class="bi bi-check-circle-fill text-success me-2"></i>Direct access to server-side services (no HTTP API round-trip)</li>
                                        <li class="list-group-item bg-transparent border-0"><i class="bi bi-check-circle-fill text-success me-2"></i>Thin client — minimal download, fast initial load</li>
                                        <li class="list-group-item bg-transparent border-0"><i class="bi bi-check-circle-fill text-success me-2"></i>Share models and validation between server and UI</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card h-100 bg-light border-0">
                                <div class="card-body">
                                    <h4 class="card-title"><i class="bi bi-exclamation-triangle text-warning me-2"></i>Considerations</h4>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item bg-transparent border-0"><i class="bi bi-dash-circle text-danger me-2"></i>Requires persistent WebSocket connection (SignalR)</li>
                                        <li class="list-group-item bg-transparent border-0"><i class="bi bi-dash-circle text-danger me-2"></i>Every UI interaction is a server round-trip</li>
                                        <li class="list-group-item bg-transparent border-0"><i class="bi bi-dash-circle text-danger me-2"></i>Server memory usage scales with connected users</li>
                                        <li class="list-group-item bg-transparent border-0"><i class="bi bi-dash-circle text-danger me-2"></i>No offline capability</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h4><i class="bi bi-code-slash me-2"></i>Technical Details</h4>
                        <div class="row g-3 mt-1">
                            <div class="col-md-4">
                                <div class="card bg-light border-0 h-100">
                                    <div class="card-body">
                                        <h6 class="fw-bold"><i class="bi bi-box me-1"></i> Blazor Server</h6>
                                        <p class="small text-muted mb-0">Components execute on the server. UI updates are sent to the browser via SignalR WebSocket in real-time.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light border-0 h-100">
                                    <div class="card-body">
                                        <h6 class="fw-bold"><i class="bi bi-arrow-repeat me-1"></i> Direct DI</h6>
                                        <p class="small text-muted mb-0">Injects <code>IEmployeeService</code> directly — no HTTP API calls needed. Data access happens server-side.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light border-0 h-100">
                                    <div class="card-body">
                                        <h6 class="fw-bold"><i class="bi bi-broadcast me-1"></i> SignalR</h6>
                                        <p class="small text-muted mb-0">Built-in SignalR hub handles all client-server communication. No manual WebSocket management.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-tools me-2"></i>Implementation by Mark Hazleton</span>
                        <a href="https://github.com/markhazleton/SampleMvcCRUD" class="btn btn-outline-primary btn-sm" target="_blank" rel="noopener noreferrer">
                            <i class="bi bi-github me-2"></i>View Source Code
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<EmployeeDto> employees = new();
    private List<DepartmentDto> departments = new();
    private bool loading = true;
    private string searchTerm = string.Empty;
    private int pageSize = 10;
    private int currentPage = 1;
    private string sortKey = "name";
    private string sortDir = "asc";
    private bool showForm;
    private EmployeeDto formEmployee = new();
    private bool saving;
    private EmployeeDto? deleteTarget;
    private string? toastMessage;
    private string toastType = "success";
    private readonly CancellationTokenSource cts = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData().ConfigureAwait(false);
        loading = false;
    }

    private async Task LoadData()
    {
        try
        {
            var empTask = EmployeeService.GetEmployeesAsync(new PagingParameterModel(), cts.Token);
            var deptTask = EmployeeService.GetDepartmentsAsync(false, cts.Token);
            await Task.WhenAll(empTask, deptTask).ConfigureAwait(false);
            employees = (await empTask.ConfigureAwait(false)).ToList();
            departments = (await deptTask.ConfigureAwait(false)).ToList();
        }
        catch (InvalidOperationException ex)
        {
            ShowToast(ex.Message, "danger");
        }
        catch (HttpRequestException ex)
        {
            ShowToast(ex.Message, "danger");
        }
    }

    // --- Sorting ---
    private void ToggleSort(string key)
    {
        if (sortKey == key)
            sortDir = sortDir == "asc" ? "desc" : "asc";
        else
        {
            sortKey = key;
            sortDir = "asc";
        }
    }

    private string SortIcon(string col)
    {
        if (sortKey != col) return "bi bi-chevron-expand text-muted";
        return sortDir == "asc" ? "bi bi-chevron-up" : "bi bi-chevron-down";
    }

    // --- Computed properties ---
    private List<EmployeeDto> Filtered =>
        string.IsNullOrEmpty(searchTerm)
            ? employees
            : employees.Where(e =>
                (e.Name ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                || (e.State ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                || (e.Country ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                || (e.DepartmentName ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
                || (e.GenderName ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase)
            ).ToList();

    private List<EmployeeDto> Sorted
    {
        get
        {
            var list = Filtered;
            return sortKey switch
            {
                "name" => sortDir == "asc" ? list.OrderBy(e => e.Name).ToList() : list.OrderByDescending(e => e.Name).ToList(),
                "genderName" => sortDir == "asc" ? list.OrderBy(e => e.GenderName).ToList() : list.OrderByDescending(e => e.GenderName).ToList(),
                "age" => sortDir == "asc" ? list.OrderBy(e => e.Age).ToList() : list.OrderByDescending(e => e.Age).ToList(),
                "state" => sortDir == "asc" ? list.OrderBy(e => e.State).ToList() : list.OrderByDescending(e => e.State).ToList(),
                "country" => sortDir == "asc" ? list.OrderBy(e => e.Country).ToList() : list.OrderByDescending(e => e.Country).ToList(),
                "departmentName" => sortDir == "asc" ? list.OrderBy(e => e.DepartmentName).ToList() : list.OrderByDescending(e => e.DepartmentName).ToList(),
                _ => list
            };
        }
    }

    private int TotalPages => (int)Math.Ceiling((double)Sorted.Count / pageSize);

    private List<EmployeeDto> Paginated =>
        Sorted.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();

    private List<int> VisiblePages
    {
        get
        {
            var pages = new List<int>();
            const int max = 5;
            int start = Math.Max(1, currentPage - max / 2);
            int end = Math.Min(TotalPages, start + max - 1);
            if (end - start + 1 < max) start = Math.Max(1, end - max + 1);
            for (int i = start; i <= end; i++) pages.Add(i);
            return pages;
        }
    }

    // --- CRUD ---
    private void OpenAdd()
    {
        formEmployee = new EmployeeDto();
        showForm = true;
    }

    private async Task OpenEdit(int id)
    {
        try
        {
            var response = await EmployeeService.FindEmployeeByIdAsync(id, cts.Token).ConfigureAwait(false);
            if (response.Resource is not null)
            {
                formEmployee = response.Resource;
                showForm = true;
            }
        }
        catch (InvalidOperationException ex) { ShowToast(ex.Message, "danger"); }
        catch (HttpRequestException ex) { ShowToast(ex.Message, "danger"); }
    }

    private async Task HandleSave()
    {
        saving = true;
        try
        {
            if (formEmployee.Id > 0)
            {
                await EmployeeService.UpdateAsync(formEmployee.Id, formEmployee, cts.Token).ConfigureAwait(false);
                ShowToast("Employee updated successfully", "success");
            }
            else
            {
                await EmployeeService.SaveAsync(formEmployee, cts.Token).ConfigureAwait(false);
                ShowToast("Employee added successfully", "success");
            }
            showForm = false;
            await LoadData().ConfigureAwait(false);
        }
        catch (InvalidOperationException ex) { ShowToast(ex.Message, "danger"); }
        catch (HttpRequestException ex) { ShowToast(ex.Message, "danger"); }
        finally { saving = false; }
    }

    private void CloseForm() => showForm = false;

    private void OpenDelete(EmployeeDto emp) => deleteTarget = emp;

    private async Task HandleDelete()
    {
        if (deleteTarget is null) return;
        try
        {
            await EmployeeService.DeleteAsync(deleteTarget.Id, cts.Token).ConfigureAwait(false);
            ShowToast("Employee deleted successfully", "success");
            deleteTarget = null;
            await LoadData().ConfigureAwait(false);
        }
        catch (InvalidOperationException ex) { ShowToast(ex.Message, "danger"); }
        catch (HttpRequestException ex) { ShowToast(ex.Message, "danger"); }
    }

    private void ShowToast(string message, string type)
    {
        toastMessage = message;
        toastType = type;
    }

    private void DismissToast() => toastMessage = null;

    public void Dispose()
    {
        cts.Dispose();
    }
}
